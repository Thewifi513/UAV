<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>远程键盘控制</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(44, 62, 80, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin: 20px 0;
        }
        
        header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: var(--light);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1rem;
        }
        
        .status-panel {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .status-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        #connection-status {
            color: var(--danger);
        }
        
        #connection-status.connected {
            color: var(--success);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
        }
        
        .control-group {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .group-title {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        .key-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .key {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .key:hover {
            background: rgba(52, 152, 219, 0.5);
        }
        
        .key:active, .key.active {
            background: rgba(46, 204, 113, 0.7);
            transform: scale(0.95);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .key-label {
            position: relative;
            z-index: 2;
        }
        
        .key-code {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.7rem;
            opacity: 0.7;
            z-index: 2;
        }
        
        .key::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.1) 100%);
            z-index: 1;
        }
        
        .emergency-section {
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .emergency-btn {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            max-width: 300px;
        }
        
        .emergency-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.6);
        }
        
        .emergency-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
        }
        
        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            display: inline-block;
            margin-right: 8px;
        }
        
        .connected .connection-indicator {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .latency-display {
            font-size: 0.9rem;
            margin-top: 5px;
            color: var(--gray);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .key-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .key {
                font-size: 1rem;
            }
            
            .emergency-btn {
                padding: 12px 20px;
                font-size: 1.1rem;
            }
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        /* 油门滑动条样式 */
        #throttle-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%);
            outline: none;
            margin: 10px 0;
        }
        
        #throttle-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--light);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
            border: 2px solid var(--dark);
            transition: all 0.2s ease;
        }
        
        #throttle-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
        }
        
        #throttle-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--light);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
            border: 2px solid var(--dark);
            transition: all 0.2s ease;
        }
        
        #throttle-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
        }
        
        .throttle-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .throttle-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .throttle-value {
            font-weight: bold;
            color: var(--light);
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 10px;
            border-radius: 5px;
            min-width: 60px;
            text-align: center;
        }
        
        .throttle-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .throttle-reset {
            background: linear-gradient(135deg, var(--warning), #d35400);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
        }
        
        .throttle-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .throttle-reset:active {
            transform: translateY(0);
        } 
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>远程飞行控制系统</h1>
            <div class="subtitle">远程操作界面</div>
        </header>
        
        <div class="status-panel">
            <div class="status-item">
                <div class="status-label">连接状态</div>
                <div id="connection-status" class="status-value">
                    <span class="connection-indicator"></span>
                    <span id="status-text">未连接</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">事件队列</div>
                <div id="queue-status" class="status-value">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">延迟</div>
                <div id="latency-status" class="status-value">-- ms</div>
            </div>
            <div class="status-item">
                <div class="status-label">活动客户端</div>
                <div id="client-status" class="status-value">1</div>
            </div>
        </div>
        
        <div class="controls-grid">
            <div class="control-group">
                <div style="margin-top: 20px;"></div>
                <div class="group-title">飞行方向控制</div>
                <div class="key-grid">
                    <div class="key" data-key="q" data-command="press:q">
                        <div class="key-label">左转</div>
                        <div class="key-code">Q</div>
                    </div>
                    <div class="key" data-key="w" data-command="press:w">
                        <div class="key-label">前进</div>
                        <div class="key-code">W</div>
                    </div>
                    <div class="key" data-key="e" data-command="press:e">
                        <div class="key-label">右转</div>
                        <div class="key-code">E</div>
                    </div>
                    <div class="key" data-key="a" data-command="press:a">
                        <div class="key-label">左移</div>
                        <div class="key-code">A</div>
                    </div>
                    <div class="key" data-key="s" data-command="press:s">
                        <div class="key-label">后退</div>
                        <div class="key-code">S</div>
                    </div>
                    <div class="key" data-key="d" data-command="press:d">
                        <div class="key-label">右移</div>
                        <div class="key-code">D</div>
                    </div>
                </div>

                <div style="border-top: 2.5px solid rgba(255,255,255,0.1); margin: 20px 0;"></div>

                <div class="group-title">高度控制</div>
                <div class="key-grid">
                    <div class="key" data-key="z" data-command="press:z">
                        <div class="key-label">上升</div>
                        <div class="key-code">Z</div>
                    </div>
                    <div class="key" data-key="x" data-command="press:x">
                        <div class="key-label">下降</div>
                        <div class="key-code">X</div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <div style="margin-top: 20px;">
                    <div class="group-title">特殊操作</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div class="key" data-key="c" data-command="press:c" style="aspect-ratio: unset; height: 60px;">
                            <div class="key-label">解锁 (C)</div>
                        </div>
                        <div class="key" data-key="l" data-command="press:l" style="aspect-ratio: unset; height: 60px;">
                            <div class="key-label">降落 (L)</div>
                        </div>
                        <div class="key" data-key="h" data-command="press:h" style="aspect-ratio: unset; height: 60px; grid-column: span 2;">
                            <div class="key-label">返航 (H)</div>
                        </div>
                    </div>
                </div>
                
                <!-- 添加油门滑动条 -->
                <div style="margin-top: 20px;">
                    <div class="group-title">油门控制</div>
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <!-- 横向排列的油门按钮 -->
                        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;">
                            <!-- 油门-按钮 -->
                            <div class="key throttle-key" data-key="j" id="throttle-decrease">
                                <div class="key-label">油门-</div>
                                <div class="key-code">J</div>
                            </div>
                            
                            <!-- 油门值显示 -->
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 100px;">
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">当前值</div>
                                <div id="throttle-value" style="font-size: 1.5rem; font-weight: bold;">0.05</div>
                            </div>
                            
                            <!-- 油门+按钮 -->
                            <div class="key throttle-key" data-key="k" id="throttle-increase">
                                <div class="key-label">油门+</div>
                                <div class="key-code">K</div>
                            </div>
                        </div>
                        
                        <!-- 油门滑动条 -->
                        <input 
                            type="range" 
                            id="throttle-slider" 
                            min="0" 
                            max="1" 
                            step="0.05" 
                            value="0.05"
                            style="width: 100%; height: 30px; margin-bottom: 5px;"
                        >
                        
                        <!-- 滑动条刻度 -->
                        <div style="display: flex; justify-content: space-between; width: 100%; font-size: 0.8rem; color: var(--gray);">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                        
                        <!-- 控制按钮 -->
                        <div style="display: flex; gap: 10px; margin-top: 15px; width: 100%;">
                            <button id="throttle-reset" class="throttle-reset" style="flex: 1;">
                                <i class="fas fa-undo-alt" style="margin-right: 5px;"></i>重置
                            </button>
                            <button id="throttle-sync" class="throttle-reset" style="flex: 1; background: linear-gradient(135deg, var(--primary), #2980b9);">
                                <i class="fas fa-sync-alt" style="margin-right: 5px;"></i>同步
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <div style="margin-top: 20px;"></div>
                <div class="group-title">系统状态</div>
                <div style="padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-top: 10px;">
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>地面站连接:</span>
                            <span id="ground-status">未连接</span>
                        </div>
                        <div style="height: 5px; background: #444; border-radius: 3px; margin-top: 5px;">
                            <div id="ground-status-bar" style="height: 100%; width: 0%; background: var(--danger); border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>事件队列:</span>
                            <span id="queue-count">0</span>
                        </div>
                        <div style="height: 5px; background: #444; border-radius: 3px; margin-top: 5px;">
                            <div id="queue-bar" style="height: 100%; width: 0%; background: var(--primary); border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>最后心跳:</span>
                            <span id="last-heartbeat">--:--:--</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div class="group-title">连接信息</div>
                    <div style="padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-top: 10px; font-size: 0.9rem;">
                        <div>IP: <span id="client-ip">获取中...</span></div>
                        <div>协议: <span id="protocol">WebSocket</span></div>
                        <div>加密: <span id="encryption">--</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="emergency-section">
            <button id="emergency-btn" class="emergency-btn pulse">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm0-5a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                </svg>
                紧急停止 (ESC)
            </button>
            <div class="latency-display" id="latency-display">最后一次延迟: -- ms</div>
        </div>
    </div>
    
    <div class="footer">
        <p>远程控制系统 v1.7</p>
    </div>

    <script>
        // 配置
        const WS_ENDPOINT = `wss://55.55.102.2:8765`; // 固定使用wss协议
        const AUTH_TOKEN = "SECURE_TOKEN_123";
        
        // DOM元素
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const queueStatus = document.getElementById('queue-status');
        const latencyStatus = document.getElementById('latency-status');
        const clientStatus = document.getElementById('client-status');
        const groundStatus = document.getElementById('ground-status');
        const groundStatusBar = document.getElementById('ground-status-bar');
        const queueCount = document.getElementById('queue-count');
        const queueBar = document.getElementById('queue-bar');
        const lastHeartbeat = document.getElementById('last-heartbeat');
        const clientIp = document.getElementById('client-ip');
        const protocolEl = document.getElementById('protocol');
        const encryptionEl = document.getElementById('encryption');
        const latencyDisplay = document.getElementById('latency-display');
        const emergencyBtn = document.getElementById('emergency-btn');
        const THROTTLE_DEBOUNCE_TIME = 300; // 300ms油门滑块防抖时间
        
        // 全局状态
        let ws = null;
        let activeKeys = new Set();
        let latency = null;
        let lastHeartbeatTime = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        let pingSentTime = null;
        let throttleDebounce = null;

        // 初始化键盘事件监听
        function initKeyboard() {
            const keys = document.querySelectorAll('.key');
            
            keys.forEach(key => {
                const command = key.dataset.command;
                const keyCode = key.dataset.key;
                
                // 鼠标事件
                key.addEventListener('mousedown', () => handleKeyDown(command, key));
                key.addEventListener('mouseup', () => handleKeyUp(command, key));
                key.addEventListener('mouseleave', () => {
                    if (activeKeys.has(keyCode)) handleKeyUp(command, key);
                });
                
                // 触摸事件
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleKeyDown(command, key);
                });
                
                key.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleKeyUp(command, key);
                });
            });
            
            // 物理键盘事件
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                const keyElement = document.querySelector(`.key[data-key="${key}"]`);
                if (key === 'j') {
                    adjustThrottle(-0.05);
                    document.getElementById('throttle-decrease').classList.add('active');
                } else if (key === 'k') {
                    adjustThrottle(0.05);
                    document.getElementById('throttle-increase').classList.add('active');
                } else if (keyElement) {
                    handleKeyDown(keyElement.dataset.command, keyElement);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                const keyElement = document.querySelector(`.key[data-key="${key}"]`);
                if (key === 'j') {
                    document.getElementById('throttle-decrease').classList.remove('active');
                } else if (key === 'k') {
                    document.getElementById('throttle-increase').classList.remove('active');
                } else if (keyElement) {
                    handleKeyUp(keyElement.dataset.command, keyElement);
                }
            });
            
            // 紧急按钮
            emergencyBtn.addEventListener('click', () => {
                sendCommand('press:\x1b');
            });
        }
        
        // 按键按下处理
        function handleKeyDown(command, element) {
            const key = element.dataset.key;
            if (!activeKeys.has(key)) {
                activeKeys.add(key);
                element.classList.add('active');
                sendCommand(command);
            }
        }
        
        // 按键释放处理
        function handleKeyUp(command, element) {
            const key = element.dataset.key;
            if (activeKeys.has(key)) {
                activeKeys.delete(key);
                element.classList.remove('active');
                
                // 发送释放命令
                const releaseCommand = command.replace('press:', 'release:');
                sendCommand(releaseCommand);
            }
        }

        // 油门调整函数
        function adjustThrottle(amount) {
            const currentThrottle = parseFloat(throttleSlider.value);
            let newThrottle = currentThrottle + amount;
            
            // 限制在0-1范围内
            if (newThrottle < 0) newThrottle = 0;
            if (newThrottle > 1) newThrottle = 1;
            
            // 四舍五入到0.05的倍数
            newThrottle = Math.round(newThrottle * 20) / 20;
            
            // 更新UI
            throttleSlider.value = newThrottle;
            throttleValue.textContent = newThrottle.toFixed(2);
            
            // 发送命令
            sendThrottleCommand(newThrottle);
        }

        // 绑定按键事件
        document.getElementById('throttle-decrease').addEventListener('mousedown', () => {
            adjustThrottle(-0.05);
        });

        document.getElementById('throttle-increase').addEventListener('mousedown', () => {
            adjustThrottle(0.05);
        });

        // 油门控制功能
        const throttleSlider = document.getElementById('throttle-slider');
        const throttleValue = document.getElementById('throttle-value');
        const throttleReset = document.getElementById('throttle-reset');
        const throttleSync = document.getElementById('throttle-sync');

        // 初始化油门值显示 (0.05 对应无人机初始值)
        throttleValue.textContent = "0.05";
        throttleSlider.value = 0.05;

        // 防抖机制 (解决虚拟机卡死问题)
        let lastThrottleTime = 0;
        const THROTTLE_INTERVAL = 200; // 200ms发送间隔

        // 油门滑动事件 (带防抖)
        throttleSlider.addEventListener('input', () => {
            clearTimeout(throttleDebounce);
            const now = Date.now();
            if (now - lastThrottleTime > THROTTLE_INTERVAL) {
                const value = parseFloat(throttleSlider.value).toFixed(2);
                throttleValue.textContent = value;
                sendThrottleCommand(value);
                lastThrottleTime = now;
            }
            // 更新UI显示
            const value = parseFloat(throttleSlider.value).toFixed(2);
            throttleValue.textContent = value;
            throttleDebounce = setTimeout(() => {
                sendThrottleCommand(value);
            }, THROTTLE_DEBOUNCE_TIME);
        });

        // 重置油门
        throttleReset.addEventListener('click', () => {
            throttleSlider.value = 0.05;
            throttleValue.textContent = '0.05';
            sendThrottleCommand(0.05);
            
            // 添加视觉反馈
            throttleReset.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i>已重置';
            setTimeout(() => {
                throttleReset.innerHTML = '<i class="fas fa-undo-alt" style="margin-right: 5px;"></i>重置';
            }, 1000);
        });

        // 同步油门状态
        throttleSync.addEventListener('click', () => {
            // 向后端请求当前油门状态
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "get_throttle"
                }));
                
                // 添加视觉反馈
                throttleSync.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i>同步中';
            }
        });

        // 发送油门命令 (带节流)
        function sendThrottleCommand(value) {
            // 格式: throttle:0.05
            const command = `throttle:${value}`;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(command);
                console.log(`油门命令已发送: ${command}`);
            } else {
                console.warn("无法发送油门命令，连接未就绪");
            }
        }

        // 在页面加载完成后添加重置按钮
        window.addEventListener('DOMContentLoaded', () => {
            addThrottleResetButton();
        });        
        
        // 发送命令到WebSocket
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: "command",
                    command: command,
                    timestamp: Date.now()
                });
                ws.send(message);
            }
        }
        
        // 更新状态显示
        function updateStatus(connected) {
            isConnected = connected;
            connectionStatus.classList.toggle('connected', connected);
            statusText.textContent = connected ? '已连接' : '未连接';
            
            if (!connected) {
                groundStatus.textContent = '未知';
                groundStatusBar.style.width = '0%';
                groundStatusBar.style.background = 'var(--danger)';
                queueBar.style.width = '0%';
                lastHeartbeat.textContent = '--:--:--';
                latencyStatus.textContent = '-- ms';
                latencyDisplay.textContent = '最后一次延迟: -- ms';
            }
        }

            // 添加证书检查函数
        async function checkCertificateTrust() {
            try {
                // 尝试访问后端HTTPS端点触发证书检查
                await fetch('https://55.55.102.2:8765', { 
                    mode: 'no-cors',
                    cache: 'no-store'
                });
            } catch (e) {
                console.warn("证书信任警告:", e);
                alert("安全证书未受信任！\n请访问 https://55.55.102.2:8765 手动添加安全例外");
            }
        }
        
        // 连接WebSocket
        function connect() {
            // 先检查证书信任状态
            checkCertificateTrust();
            
            ws = new WebSocket(WS_ENDPOINT);
            
            ws.onopen = () => {
                // 关键修复：直接发送文本令牌（非JSON）
                ws.send(AUTH_TOKEN); 
                
                updateStatus(true);
                reconnectAttempts = 0;
                emergencyBtn.classList.add('pulse');
                getClientIp();
                sendPing();
                
                console.log("WebSocket连接已建立，认证令牌已发送");
            };
            
            ws.onmessage = (event) => {
                try {
                    // 处理认证响应
                    if (typeof event.data === 'string' && event.data.includes("auth_success")) {
                        console.log("认证成功:", event.data);
                        statusText.textContent = '已认证';
                        return;
                    }
                    
                    // 处理JSON数据
                    const data = JSON.parse(event.data);
                    // 处理油门状态响应
                    if (data.type === "throttle_status") {
                        const throttle = data.throttle.toFixed(2);
                        throttleValue.textContent = throttle;
                        throttleSlider.value = throttle;
                        
                        // 更新同步按钮状态
                        if (throttleSync.innerHTML.includes('fa-spinner')) {
                            throttleSync.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 5px;"></i>同步';
                        }
                    }
                    switch (data.type) {
                        case 'status':
                            updateSystemStatus(data);
                            break;
                        case 'heartbeat':
                            handleHeartbeat(data);
                            break;
                        case 'pong':
                            calculateLatency(data.timestamp);
                            break;
                        default:
                            console.log("收到消息:", data);
                    }
                } catch (e) {
                    // 处理非JSON响应（如心跳确认）
                    if (event.data === "heartbeat:ack") {
                        console.log("心跳确认收到");
                    } else {
                        console.error('消息解析错误:', e, "原始数据:", event.data);
                    }
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
                
                // 特定错误处理
                if (error.message.includes("SSL") || error.message.includes("证书")) {
                    alert("SSL证书错误: " + error.message + "\n请确保已信任证书");
                }
                
                updateStatus(false);
            };
            
            ws.onclose = (event) => {
                console.log("连接关闭:", event.code, event.reason);
                updateStatus(false);
                emergencyBtn.classList.remove('pulse');
                
                // 增强重连逻辑
                if (reconnectAttempts < 5) {
                    reconnectAttempts++;
                    const delay = Math.min(5000, reconnectAttempts * 1500);
                    console.log(`将在 ${delay}ms 后尝试重连 (#${reconnectAttempts})`);
                    setTimeout(connect, delay);
                } else {
                    alert("连接已断开，重试次数超过限制");
                }
            };
        }

        // 发送命令函数优化
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // 关键修复：直接发送文本命令（非JSON）
                ws.send(command); 
                console.log("命令已发送:", command);
            } else {
                console.warn("无法发送命令，连接未就绪");
                // 尝试重新连接
                if (!isConnected) connect();
            }
        }

        // 更新状态显示 - 添加认证状态
        function updateStatus(connected) {
            isConnected = connected;
            connectionStatus.classList.toggle('connected', connected);
            
            if (connected) {
                statusText.textContent = '已连接（认证中）';
                statusText.style.color = '#f39c12'; // 橙色表示未认证
            } else {
                statusText.textContent = '未连接';
                statusText.style.color = '#e74c3c'; // 红色
            }
        }

        // 页面加载完成后初始化 - 添加重连按钮
        window.addEventListener('DOMContentLoaded', () => {
            // 添加手动重连按钮
            const reconnectBtn = document.createElement('button');
            reconnectBtn.textContent = '手动重连';
            reconnectBtn.style = `position: fixed; bottom: 20px; right: 20px; 
                padding: 10px 15px; background: #3498db; color: white;
                border: none; border-radius: 5px; cursor: pointer; z-index: 1000;`;
            reconnectBtn.onclick = () => {
                reconnectAttempts = 0;
                connect();
            };
            document.body.appendChild(reconnectBtn);
            
            // 初始化
            protocolEl.textContent = 'WSS';
            encryptionEl.textContent = 'TLS 1.3';
            initKeyboard();
            connect();
        });
    </script>
</body>
</html>